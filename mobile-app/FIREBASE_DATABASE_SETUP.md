# Firebase Database Setup Guide

## üóÑÔ∏è Database Structure

Your SafeGuard app uses a comprehensive Firestore schema optimized for SOS alerts with AI analysis.

## üìã Required Collections

### 1. Collection: `sos-alerts`
Main collection for SOS emergency reports.

**Example Document:**
```javascript
// Document ID: auto-generated by Firebase
{
  // REQUIRED FIELDS (from mobile app)
  "userId": "user123456",                    // String - User identifier
  "message": "Traffic accident with injury", // String - Emergency description
  "videoUrl": "https://firebasestorage.googleapis.com/...",  // String - Video URL from Firebase Storage
  "location": {                              // Object - GPS coordinates
    "latitude": 28.7041,                     // Number
    "longitude": 77.1025,                    // Number  
    "address": "New Delhi, India"            // String - Reverse geocoded address
  },
  "createdAt": "Firebase Timestamp",         // Timestamp - When report was created
  
  // OPTIONAL FIELDS (added by system)
  "status": "pending",                       // String - pending/approved/rejected
  
  // GEMINI ANALYSIS FIELDS (added after AI analysis)
  "geminiAnalysis": {                        // Object - Gemini AI results
    "is_emergency": true,                    // Boolean - Emergency classification  
    "reason": "Video shows traffic accident with injured person", // String
    "primary_service": "Ambulance",          // String - Police/Ambulance/Fire Brigade (or null)
    "confidence": "High",                    // String - High/Medium/Low (or null)
    "analyzedAt": "Firebase Timestamp",     // Timestamp
    "videoUrl": "https://...",              // String - Video that was analyzed
    "apiVersion": "gemini-1.5-flash",       // String - AI model version
    "error": false,                         // Boolean - If analysis failed
    "error_message": null                   // String - Error details if failed
  },
  
  // CONVENIENCE FIELDS (extracted from geminiAnalysis for easier querying)
  "isEmergency": true,                      // Boolean - Direct access to emergency status
  "primaryService": "Ambulance",           // String - Direct access to service type
  "analysisConfidence": "High",            // String - Direct access to confidence
  "lastUpdated": "Firebase Timestamp",     // Timestamp - Last modification
  
  // ADMIN REVIEW FIELDS (optional)
  "adminReview": {                         // Object - Admin actions
    "decision": "approved",                // String - approved/rejected
    "adminNotes": "Verified emergency",    // String - Admin comments
    "reviewedAt": "Firebase Timestamp",    // Timestamp
    "notificationsSent": true              // Boolean - If notifications were sent
  }
}
```

### 2. Collection: `analysis-logs`
Tracks all AI analysis attempts for audit purposes.

**Example Document:**
```javascript
// Document ID: auto-generated by Firebase  
{
  "reportId": "sos-alert-document-id",     // String - Reference to sos-alerts document
  "videoUrl": "https://...",               // String - Video that was analyzed
  "analysis": {                            // Object - Complete Gemini response
    "is_emergency": true,
    "reason": "Traffic accident detected",
    "primary_service": "Ambulance", 
    "confidence": "High"
  },
  "analyzedAt": "Firebase Timestamp",      // Timestamp
  "status": "completed"                    // String - completed/failed
}
```

### 3. Collection: `alerts`
System-wide alerts created by administrators.

**Example Document:**
```javascript
// Document ID: auto-generated by Firebase
{
  "id": "alert123",                        // String - Alert identifier
  "title": "Flood Warning",               // String - Alert title
  "message": "Heavy rainfall expected",    // String - Alert message
  "severity": "high",                      // String - low/medium/high
  "location": "Delhi",                     // String - Affected area
  "radius": 5000,                         // Number - Alert radius in meters
  "duration": 120,                        // Number - Duration in minutes
  "createdAt": "Firebase Timestamp",      // Timestamp
  "expiresAt": "Firebase Timestamp",      // Timestamp
  "isActive": true                        // Boolean - If alert is still active
}
```

### 4. Collection: `notificationLogs`
Audit trail of all notifications sent.

**Example Document:**
```javascript
// Document ID: auto-generated by Firebase
{
  "reportId": "sos-alert-document-id",     // String - Reference to sos-alerts
  "type": "enhanced_emergency_dispatch_sms", // String - Notification type
  "emergencyServices": [                   // Array - Services notified
    {
      "recipient": "Delhi Fire Station",
      "phone": "+91-9996101244", 
      "message": "üö® EMERGENCY DISPATCH ALERT...",
      "success": true
    }
  ],
  "publicRecipients": [                    // Array - Public users notified
    {
      "name": "User A",
      "phone": "+91-9876543210",
      "distance": "0.2km"
    }
  ],
  "sentAt": "Firebase Timestamp",          // Timestamp
  "status": "sent"                         // String - sent/failed
}
```

## üîç Required Database Indexes

For optimal performance, create these composite indexes in Firebase Console:

### Index 1: Emergency videos query
- **Collection**: `sos-alerts`
- **Fields**: `isEmergency` (Ascending), `createdAt` (Descending)

### Index 2: Analysis status query
- **Collection**: `sos-alerts`
- **Fields**: `geminiAnalysis.analyzedAt` (Ascending), `videoUrl` (Ascending)

### Index 3: User reports query
- **Collection**: `sos-alerts`
- **Fields**: `userId` (Ascending), `createdAt` (Descending)

### Index 4: Service type query
- **Collection**: `sos-alerts`
- **Fields**: `primaryService` (Ascending), `createdAt` (Descending)

## üõ†Ô∏è Setup Instructions

### Step 1: Create Collections

1. **Go to Firebase Console**: https://console.firebase.google.com
2. **Select your project**: `crowd-monitoring-e1f70`
3. **Navigate to Firestore Database**
4. **Create each collection** by adding a sample document:

**For `sos-alerts`:**
- Click "Start collection"
- Collection ID: `sos-alerts`
- Add a sample document with the structure shown above

**For `analysis-logs`:**
- Collection ID: `analysis-logs`
- Add a sample document

**For `alerts`:**
- Collection ID: `alerts`
- Add a sample document

**For `notificationLogs`:**
- Collection ID: `notificationLogs`
- Add a sample document

### Step 2: Configure Security Rules

1. **Go to Firestore Database** ‚Üí **Rules**
2. **Copy the contents** of `mobile-app/firestore.rules`
3. **Paste and publish** the rules

### Step 3: Create Indexes

1. **Go to Firestore Database** ‚Üí **Indexes**
2. **Create composite indexes** as listed above
3. **Wait for indexes to build** (may take a few minutes)

### Step 4: Enable Authentication

1. **Go to Authentication** ‚Üí **Sign-in method**
2. **Enable "Anonymous" authentication**
3. **Save changes**

## üì± Mobile App Integration

Your mobile app will send data in this format:

```javascript
// Required fields from mobile app
{
  "userId": "unique_user_identifier",
  "message": "User's emergency description", 
  "videoUrl": "Firebase Storage URL after upload",
  "location": {
    "latitude": GPS_LATITUDE,
    "longitude": GPS_LONGITUDE,
    "address": "Reverse geocoded address"
  }
}
```

## üîç Query Examples

```javascript
// Get all emergency videos
const emergencyQuery = query(
  collection(db, 'sos-alerts'),
  where('isEmergency', '==', true),
  orderBy('createdAt', 'desc')
);

// Get videos pending analysis
const pendingQuery = query(
  collection(db, 'sos-alerts'),
  where('geminiAnalysis', '==', null),
  where('videoUrl', '!=', null)
);

// Get videos by service type  
const ambulanceQuery = query(
  collection(db, 'sos-alerts'),
  where('primaryService', '==', 'Ambulance'),
  orderBy('createdAt', 'desc')
);
```

## ‚úÖ Verification

After setup, your app should:
- ‚úÖ Connect to Firebase without errors
- ‚úÖ Create SOS alerts with proper structure
- ‚úÖ Store data in the correct collections
- ‚úÖ Support real-time updates

## üéØ Next Steps

1. **Set up the collections and indexes**
2. **Deploy the security rules**
3. **Test SOS alert creation from mobile app**
4. **Verify data structure in Firebase Console**
5. **Set up admin panel to read from these collections**

Your database is now ready for the complete SOS alert workflow with AI analysis integration!
